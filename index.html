<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Darts Scorer</title>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #34495e;
      --accent: #3498db;
      --success: #2ecc71;
      --danger: #e74c3c;
      --warning: #f39c12;
      --light: #ecf0f1;
      --dark: #1a252f;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--dark);
      color: #fff;
      min-height: 100vh;
    }
    
    header {
      background: var(--primary);
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      border-bottom: 3px solid var(--accent);
    }
    
    .page { display: none; padding: 1rem; max-width: 800px; margin: 0 auto; }
    .page.active { display: block; }
    
    /* Match page uses full width for 3-column layout */
    #matchPage.active { display: block; max-width: 100%; padding: 0.5rem; }
    
    h2 { margin: 1.5rem 0 1rem; color: var(--accent); border-bottom: 1px solid var(--secondary); padding-bottom: 0.5rem; }
    h3 { margin: 1rem 0 0.5rem; color: var(--light); }
    
    label { display: block; margin-top: 0.8rem; color: var(--light); font-size: 0.9rem; }
    
    select, input, button {
      font-size: 1rem;
      padding: 0.7rem;
      margin: 0.3rem 0;
      width: 100%;
      border: none;
      border-radius: 6px;
    }
    
    select, input {
      background: var(--secondary);
      color: #fff;
    }
    
    select:focus, input:focus { outline: 2px solid var(--accent); }
    
    button {
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    button:hover { opacity: 0.9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .btn-success { background: var(--success); }
    .btn-danger { background: var(--danger); }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-secondary { background: var(--secondary); }
    
    .btn-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
    .btn-row button { flex: 1; }
    
    .player-list {
      background: var(--secondary);
      border-radius: 8px;
      padding: 0.5rem;
      margin-top: 1rem;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .player-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid var(--dark);
    }
    .player-item:last-child { border-bottom: none; }
    .player-item button { width: auto; padding: 0.3rem 0.8rem; font-size: 0.85rem; }
    
    /* Match Page Styles */
    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      padding: 0.8rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    
    .match-header .player-name {
      font-weight: 700;
      font-size: 1.1rem;
      max-width: 35%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .match-header .match-score {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--accent);
    }
    
    .score-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--secondary);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .score-table th {
      background: var(--primary);
      padding: 0.6rem;
      font-size: 0.85rem;
      color: var(--light);
    }
    
    .score-table td {
      padding: 0.5rem;
      text-align: center;
      border-bottom: 1px solid var(--dark);
    }
    
    .score-table .to-go {
      font-weight: 700;
      font-size: 1.3rem;
    }
    
    .score-table .dart-count {
      background: var(--dark);
      color: var(--accent);
      font-weight: 600;
    }
    
    .score-table .current-turn {
      background: rgba(52, 152, 219, 0.2);
    }
    
    .score-table .editable:hover {
      background: rgba(52, 152, 219, 0.3);
      cursor: pointer;
    }
    
    .score-history {
      max-height: 300px;
      overflow-y: auto;
      margin: 1rem 0;
      border-radius: 8px;
    }
    
    .keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.4rem;
      margin-top: 1rem;
    }
    
    .keypad button {
      padding: 1rem;
      font-size: 1.3rem;
      font-weight: 700;
    }
    
    #scoreDisplay {
      grid-column: 1 / -1;
      background: var(--secondary);
      color: #fff;
      font-size: 2rem;
      text-align: center;
      padding: 0.8rem;
      border-radius: 6px;
      min-height: 60px;
    }
    
    .action-bar {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .action-bar button { flex: 1; padding: 0.6rem; font-size: 0.9rem; }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active { display: flex; }
    
    .modal-content {
      background: var(--secondary);
      padding: 1.5rem;
      border-radius: 12px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    
    .modal-content h3 { margin-bottom: 1rem; color: var(--accent); }
    .modal-content p { margin-bottom: 1rem; }
    
    .dart-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; }
    .dart-buttons button { flex: 1; padding: 1rem; font-size: 1.1rem; }
    
    /* Stats Page */
    .stats-section {
      background: var(--secondary);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    
    .stats-section h4 {
      background: var(--primary);
      margin: -1rem -1rem 1rem -1rem;
      padding: 0.7rem;
      text-align: center;
      border-radius: 8px 8px 0 0;
    }
    
    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid var(--dark);
    }
    .stat-row:last-child { border-bottom: none; }
    .stat-value { font-weight: 600; color: var(--accent); }
    
    .year-selector {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .year-selector button { width: auto; padding: 0.5rem 1rem; }
    .year-selector span { font-size: 1.5rem; font-weight: 700; }
    
    /* 3-Column Match Layout - iPad Friendly */
    .match-layout {
      display: grid;
      grid-template-columns: 1fr 2fr 1fr;
      gap: 0.5rem;
      height: calc(100vh - 60px);
      padding: 0.5rem;
    }
    
    .webcam-column {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    
    .webcam-box {
      background: var(--secondary);
      border-radius: 8px;
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .webcam-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      padding: 0.4rem 0.6rem;
    }
    
    .webcam-label {
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .webcam-toggle-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
      width: auto;
      margin: 0;
      background: var(--accent);
    }
    
    .webcam-toggle-btn.active {
      background: var(--danger);
    }
    
    .webcam-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    .webcam-box video {
      width: 100%;
      flex: 1;
      object-fit: cover;
      background: #000;
    }
    
    .webcam-placeholder {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--dark);
      color: #999;
      font-size: 0.9rem;
      text-align: center;
      padding: 1rem;
      line-height: 1.5;
    }
    
    .webcam-placeholder small {
      color: #777;
      margin-top: 0.3rem;
    }
    
    .scoring-column {
      display: flex;
      flex-direction: column;
      max-width: 450px;
      margin: 0 auto;
      width: 100%;
      height: 100%;
      min-height: 0;
    }
    
    .scoring-top {
      flex-shrink: 0;
    }
    
    .score-history {
      flex: 1;
      overflow-y: auto;
      margin: 0.5rem 0;
      border-radius: 8px;
      min-height: 100px;
    }
    
    .keypad {
      flex-shrink: 0;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.3rem;
    }
    
    .keypad button {
      padding: 0.8rem;
      font-size: 1.2rem;
      font-weight: 700;
    }
    
    #scoreDisplay {
      grid-column: 1 / -1;
      background: var(--secondary);
      color: #fff;
      font-size: 1.8rem;
      text-align: center;
      padding: 0.6rem;
      border-radius: 6px;
      min-height: 50px;
    }
    
    .action-bar {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 0.5rem;
    }
    .action-bar button { 
      flex: 1; 
      padding: 0.5rem; 
      font-size: 0.8rem; 
    }
    
    .match-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      padding: 0.5rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    
    .match-header .player-name {
      font-weight: 700;
      font-size: 1rem;
      max-width: 35%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .match-header .match-score {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--accent);
    }
    
    /* iPad Portrait (768px) and Landscape (1024px) */
    @media (min-width: 768px) and (max-width: 1024px) {
      .match-layout {
        grid-template-columns: 1fr 1.5fr 1fr;
      }
      .keypad button {
        padding: 1rem;
        font-size: 1.4rem;
      }
      #scoreDisplay {
        font-size: 2rem;
        padding: 0.8rem;
      }
    }
    
    /* Small tablets and large phones */
    @media (max-width: 767px) {
      .match-layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
        height: auto;
        min-height: calc(100vh - 60px);
      }
      .webcam-column { 
        flex-direction: row;
        height: 120px;
      }
      .webcam-column.left { order: 1; }
      .scoring-column { order: 2; height: auto; }
      .webcam-column.right { order: 3; }
      .webcam-box { min-height: 120px; }
    }
    
    /* Small phones */
    @media (max-width: 500px) {
      .match-header .player-name { font-size: 0.85rem; }
      .match-header .match-score { font-size: 1.1rem; }
      .keypad button { padding: 0.7rem; font-size: 1rem; }
      .action-bar button { font-size: 0.7rem; padding: 0.4rem; }
      .webcam-column { height: 100px; }
    }
    
    /* Practice Page Styles */
    .practice-layout {
      display: flex;
      justify-content: center;
      padding: 0.5rem;
      height: calc(100vh - 60px);
    }
    
    .practice-column {
      display: flex;
      flex-direction: column;
      max-width: 500px;
      width: 100%;
      height: 100%;
      min-height: 0;
    }
    
    .practice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--primary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }
    
    .practice-header .player-name {
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    .practice-info {
      color: var(--accent);
      font-weight: 600;
      font-size: 0.9rem;
    }
    
    .practice-score-display {
      background: var(--secondary);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 0.5rem;
    }
    
    .practice-score-display .big-score {
      display: block;
      font-size: 4rem;
      font-weight: 800;
      color: var(--accent);
      line-height: 1;
    }
    
    .practice-score-display .score-label {
      display: block;
      font-size: 0.9rem;
      color: #999;
      margin-top: 0.3rem;
    }
    
    .practice-stats-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .practice-stat {
      flex: 1;
      background: var(--secondary);
      border-radius: 8px;
      padding: 0.6rem;
      text-align: center;
    }
    
    .practice-stat .stat-label {
      display: block;
      font-size: 0.75rem;
      color: #999;
      margin-bottom: 0.2rem;
    }
    
    .practice-stat .stat-value {
      display: block;
      font-size: 1.2rem;
      font-weight: 700;
      color: #fff;
    }
    
    @media (max-width: 500px) {
      .practice-score-display .big-score { font-size: 3rem; }
      .practice-score-display { padding: 1rem; }
      .practice-stat .stat-value { font-size: 1rem; }
    }
  </style>
</head>
<body>

<header>Darts Scorer</header>

<!-- HOME PAGE -->
<div id="homePage" class="page active">
  <h2>Practice Mode</h2>
  
  <label for="practicePlayerSelect">Player</label>
  <select id="practicePlayerSelect" aria-label="Select Player for Practice"></select>
  
  <label for="practiceGameTypeSelect">Game Type</label>
  <select id="practiceGameTypeSelect" aria-label="Select Practice Game Type">
    <option value="501">501</option>
    <option value="301">301</option>
  </select>
  
  <button id="startPracticeBtn" class="btn-success" style="margin-top: 1rem;">Start Practice</button>
  
  <h2>New Match</h2>
  
  <label for="player1Select">Player 1</label>
  <select id="player1Select" aria-label="Select Player 1"></select>
  
  <label for="player2Select">Player 2</label>
  <select id="player2Select" aria-label="Select Player 2"></select>
  
  <label for="gameTypeSelect">Game Type</label>
  <select id="gameTypeSelect" aria-label="Select Game Type">
    <option value="501">501</option>
    <option value="301">301</option>
  </select>
  
  <label for="matchFormatSelect">Match Format</label>
  <select id="matchFormatSelect" aria-label="Select Match Format">
    <option value="legs">Best of Legs</option>
    <option value="sets">Best of Sets (3 legs = 1 set)</option>
  </select>
  
  <label for="matchLengthSelect">Best of</label>
  <select id="matchLengthSelect" aria-label="Select Match Length">
    <option value="1">1</option>
    <option value="3">3</option>
    <option value="5" selected>5</option>
    <option value="7">7</option>
    <option value="9">9</option>
    <option value="11">11</option>
    <option value="13">13</option>
  </select>
  
  <button id="startMatchBtn" class="btn-success" style="margin-top: 1rem;">Start Match</button>
  
  <h2>Manage Players</h2>
  
  <label for="newPlayerInput">Create New Player</label>
  <input type="text" id="newPlayerInput" placeholder="Enter player name" aria-label="Enter new player name" />
  <button id="addPlayerBtn">Add Player</button>
  
  <h3>Existing Players</h3>
  <div id="playerList" class="player-list" role="list" aria-label="List of players"></div>
</div>

<!-- MATCH PAGE -->
<div id="matchPage" class="page">
  <div class="match-layout">
    <!-- Left Webcam Column - Player 1 -->
    <div class="webcam-column left">
      <div class="webcam-box" id="webcamBox1">
        <div class="webcam-header">
          <span class="webcam-label" id="webcam1Label">Player 1</span>
          <button id="toggleWebcam1Btn" class="webcam-toggle-btn" aria-label="Toggle webcam for Player 1">Enable</button>
        </div>
        <div class="webcam-content">
          <video id="webcam1" autoplay playsinline muted style="display: none;"></video>
          <div class="webcam-placeholder" id="webcam1Placeholder">
            <span>Webcam Off</span>
            <small>Click "Enable" above</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Center Scoring Column -->
    <div class="scoring-column">
      <div class="scoring-top">
        <div class="action-bar">
          <button id="newLegBtn" class="btn-secondary">New Leg</button>
          <button id="finishBtn" class="btn-warning">Finish</button>
          <button id="statsBtn" class="btn-secondary">Stats</button>
          <button id="menuBtn" class="btn-secondary">Menu</button>
        </div>
        
        <div class="match-header">
          <span class="player-name" id="p1NameDisplay"></span>
          <span class="match-score" id="matchScoreDisplay">0 - 0</span>
          <span class="player-name" id="p2NameDisplay"></span>
        </div>
      </div>
      
      <div class="score-history" id="scoreHistory">
        <table class="score-table">
          <thead>
            <tr>
              <th>Scored</th>
              <th>To Go</th>
              <th>Darts</th>
              <th>To Go</th>
              <th>Scored</th>
            </tr>
          </thead>
          <tbody id="scoreTableBody"></tbody>
        </table>
      </div>
      
      <div class="keypad">
        <div id="scoreDisplay" aria-live="polite"></div>
        <button data-num="1">1</button>
        <button data-num="2">2</button>
        <button data-num="3">3</button>
        <button data-num="4">4</button>
        <button data-num="5">5</button>
        <button data-num="6">6</button>
        <button data-num="7">7</button>
        <button data-num="8">8</button>
        <button data-num="9">9</button>
        <button id="backspaceBtn" class="btn-secondary" aria-label="Backspace">&#9003;</button>
        <button data-num="0">0</button>
        <button id="enterBtn" class="btn-success">Enter</button>
      </div>
    </div>
    
    <!-- Right Webcam Column - Player 2 -->
    <div class="webcam-column right">
      <div class="webcam-box" id="webcamBox2">
        <div class="webcam-header">
          <span class="webcam-label" id="webcam2Label">Player 2</span>
          <button id="toggleWebcam2Btn" class="webcam-toggle-btn" aria-label="Toggle webcam for Player 2">Enable</button>
        </div>
        <div class="webcam-content">
          <video id="webcam2" autoplay playsinline muted style="display: none;"></video>
          <div class="webcam-placeholder" id="webcam2Placeholder">
            <span>Webcam Off</span>
            <small>Click "Enable" above</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRACTICE PAGE -->
<div id="practicePage" class="page">
  <div class="practice-layout">
    <div class="practice-column">
      <div class="scoring-top">
        <div class="action-bar">
          <button id="practiceNewLegBtn" class="btn-secondary">New Leg</button>
          <button id="practiceFinishBtn" class="btn-warning">Finish</button>
          <button id="practiceStatsBtn" class="btn-secondary">Stats</button>
          <button id="practiceMenuBtn" class="btn-secondary">Menu</button>
        </div>
        
        <div class="practice-header">
          <span class="player-name" id="practicePlayerName"></span>
          <span class="practice-info">Practice</span>
        </div>
        
        <div class="practice-score-display">
          <span class="big-score" id="practiceToGo">501</span>
          <span class="score-label">To Go</span>
        </div>
        
        <div class="practice-stats-row">
          <div class="practice-stat">
            <span class="stat-label">Darts</span>
            <span class="stat-value" id="practiceDartCount">0</span>
          </div>
          <div class="practice-stat">
            <span class="stat-label">Avg</span>
            <span class="stat-value" id="practiceAvg">0.00</span>
          </div>
          <div class="practice-stat">
            <span class="stat-label">Legs</span>
            <span class="stat-value" id="practiceLegsWon">0</span>
          </div>
        </div>
      </div>
      
      <div class="score-history" id="practiceScoreHistory">
        <table class="score-table">
          <thead>
            <tr>
              <th>Scored</th>
              <th>To Go</th>
              <th>Darts</th>
            </tr>
          </thead>
          <tbody id="practiceScoreTableBody"></tbody>
        </table>
      </div>
      
      <div class="keypad">
        <div id="practiceScoreDisplay" aria-live="polite"></div>
        <button class="practice-num" data-num="1">1</button>
        <button class="practice-num" data-num="2">2</button>
        <button class="practice-num" data-num="3">3</button>
        <button class="practice-num" data-num="4">4</button>
        <button class="practice-num" data-num="5">5</button>
        <button class="practice-num" data-num="6">6</button>
        <button class="practice-num" data-num="7">7</button>
        <button class="practice-num" data-num="8">8</button>
        <button class="practice-num" data-num="9">9</button>
        <button id="practiceBackspaceBtn" class="btn-secondary" aria-label="Backspace">&#9003;</button>
        <button class="practice-num" data-num="0">0</button>
        <button id="practiceEnterBtn" class="btn-success">Enter</button>
      </div>
    </div>
  </div>
</div>

<!-- PRACTICE CHECKOUT MODAL -->
<div id="practiceCheckoutModal" class="modal" role="dialog" aria-labelledby="practiceCheckoutTitle">
  <div class="modal-content">
    <h3 id="practiceCheckoutTitle">Checkout!</h3>
    <p>Which dart did you finish with?</p>
    <div class="dart-buttons">
      <button id="practiceDart1Btn" class="btn-success">1st</button>
      <button id="practiceDart2Btn" class="btn-success">2nd</button>
      <button id="practiceDart3Btn" class="btn-success">3rd</button>
    </div>
  </div>
</div>

<!-- PRACTICE LEG WON MODAL -->
<div id="practiceLegWonModal" class="modal" role="dialog" aria-labelledby="practiceLegWonTitle">
  <div class="modal-content">
    <h3 id="practiceLegWonTitle">Leg Complete!</h3>
    <p id="practiceLegWonMessage"></p>
    <button id="practiceNextLegBtn" class="btn-success" style="margin-top: 1rem;">Next Leg</button>
    <button id="practiceEndSessionBtn" class="btn-secondary" style="margin-top: 0.5rem;">End Practice</button>
  </div>
</div>

<!-- PRACTICE MENU MODAL -->
<div id="practiceMenuModal" class="modal" role="dialog" aria-labelledby="practiceMenuTitle">
  <div class="modal-content">
    <h3 id="practiceMenuTitle">Menu</h3>
    <button id="practiceEndBtn" class="btn-danger" style="margin-bottom: 0.5rem;">End Practice</button>
    <button id="practiceHomeBtn" class="btn-secondary" style="margin-bottom: 0.5rem;">Return to Home</button>
    <button id="closePracticeMenuBtn">Close</button>
  </div>
</div>

<!-- STATS PAGE -->
<div id="statsPage" class="page">
  <button id="backFromStatsBtn" class="btn-secondary" style="margin-bottom: 1rem;">Back</button>
  
  <h2 id="statsPlayerName">Player Stats</h2>
  
  <div class="year-selector">
    <button id="prevYearBtn" aria-label="Previous year">&lt;</button>
    <span id="statsYear">2026</span>
    <button id="nextYearBtn" aria-label="Next year">&gt;</button>
  </div>
  
  <div class="stats-section">
    <h4>Totals</h4>
    <div class="stat-row"><span>Sets</span><span class="stat-value" id="statSets">0 / 0 (0%)</span></div>
    <div class="stat-row"><span>Legs</span><span class="stat-value" id="statLegs">0 / 0 (0%)</span></div>
    <div class="stat-row"><span>100+</span><span class="stat-value" id="stat100">0</span></div>
    <div class="stat-row"><span>140+</span><span class="stat-value" id="stat140">0</span></div>
    <div class="stat-row"><span>180s</span><span class="stat-value" id="stat180">0</span></div>
    <div class="stat-row"><span>High Out</span><span class="stat-value" id="statHighOut">0</span></div>
    <div class="stat-row"><span>Best Leg</span><span class="stat-value" id="statBestLeg">-</span></div>
    <div class="stat-row"><span>Worst Leg</span><span class="stat-value" id="statWorstLeg">-</span></div>
  </div>
  
  <div class="stats-section">
    <h4>Averages</h4>
    <div class="stat-row"><span>Darts (per leg)</span><span class="stat-value" id="statAvgDarts">0</span></div>
    <div class="stat-row"><span>Score (per 3 darts)</span><span class="stat-value" id="statAvgScore">0</span></div>
    <div class="stat-row"><span>First 9</span><span class="stat-value" id="statFirst9">0</span></div>
  </div>
</div>

<!-- MENU MODAL -->
<div id="menuModal" class="modal" role="dialog" aria-labelledby="menuTitle">
  <div class="modal-content">
    <h3 id="menuTitle">Menu</h3>
    <button id="cancelMatchBtn" class="btn-danger" style="margin-bottom: 0.5rem;">Cancel Match</button>
    <button id="homeBtn" class="btn-secondary" style="margin-bottom: 0.5rem;">Return to Home</button>
    <button id="closeMenuBtn">Close</button>
  </div>
</div>

<!-- CHECKOUT MODAL -->
<div id="checkoutModal" class="modal" role="dialog" aria-labelledby="checkoutTitle">
  <div class="modal-content">
    <h3 id="checkoutTitle">Checkout!</h3>
    <p>Which dart did you finish with?</p>
    <div class="dart-buttons">
      <button id="dart1Btn" class="btn-success">1st</button>
      <button id="dart2Btn" class="btn-success">2nd</button>
      <button id="dart3Btn" class="btn-success">3rd</button>
    </div>
  </div>
</div>

<!-- EDIT SCORE MODAL -->
<div id="editModal" class="modal" role="dialog" aria-labelledby="editTitle">
  <div class="modal-content">
    <h3 id="editTitle">Edit Score</h3>
    <p>Enter new score for this turn:</p>
    <input type="number" id="editScoreInput" min="0" max="180" />
    <div class="btn-row" style="margin-top: 1rem;">
      <button id="saveEditBtn" class="btn-success">Save</button>
      <button id="cancelEditBtn" class="btn-secondary">Cancel</button>
    </div>
  </div>
</div>

<!-- LEG WON MODAL -->
<div id="legWonModal" class="modal" role="dialog" aria-labelledby="legWonTitle">
  <div class="modal-content">
    <h3 id="legWonTitle">Leg Won!</h3>
    <p id="legWonMessage"></p>
    <button id="continueLegBtn" class="btn-success" style="margin-top: 1rem;">Continue</button>
  </div>
</div>

<!-- MATCH WON MODAL -->
<div id="matchWonModal" class="modal" role="dialog" aria-labelledby="matchWonTitle">
  <div class="modal-content">
    <h3 id="matchWonTitle">Match Won!</h3>
    <p id="matchWonMessage"></p>
    <button id="newMatchBtn" class="btn-success" style="margin-top: 1rem;">New Match</button>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  const STORAGE_PLAYERS = 'dartsPlayers';
  const STORAGE_STATS = 'dartsStats';
  const MAX_SCORE = 180;
  
  let players = [];
  let stats = {};
  let match = null;
  let inputValue = '';
  let pendingCheckout = null;
  let editingTurn = null;
  let statsViewPlayer = null;
  let statsViewYear = new Date().getFullYear();
  let webcamsEnabled = false;
  let mediaStreams = [];
  
  // Practice mode variables
  let practice = null;
  let practiceInputValue = '';
  let practicePendingCheckout = null;
  
  // Utility functions
  function $(id) { return document.getElementById(id); }
  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    $(id).classList.add('active');
  }
  function showModal(id) { $(id).classList.add('active'); }
  function hideModal(id) { $(id).classList.remove('active'); }
  
  // Data persistence
  function loadData() {
    try {
      players = JSON.parse(localStorage.getItem(STORAGE_PLAYERS)) || [];
      stats = JSON.parse(localStorage.getItem(STORAGE_STATS)) || {};
    } catch(e) {
      players = [];
      stats = {};
    }
  }
  
  function savePlayers() {
    localStorage.setItem(STORAGE_PLAYERS, JSON.stringify(players));
  }
  
  function saveStats() {
    localStorage.setItem(STORAGE_STATS, JSON.stringify(stats));
  }
  
  // Initialize player stats structure
  function initPlayerStats(playerName, year) {
    if (!stats[playerName]) stats[playerName] = {};
    if (!stats[playerName][year]) {
      stats[playerName][year] = {
        setsWon: 0, setsPlayed: 0,
        legsWon: 0, legsPlayed: 0,
        scores100: 0, scores140: 0, scores180: 0,
        highOut: 0, bestLeg: null, worstLeg: null,
        totalDarts: 0, totalLegsForAvg: 0,
        totalScore: 0, totalThrows: 0,
        first9Total: 0, first9Count: 0
      };
    }
    return stats[playerName][year];
  }
  
  // Render player dropdowns and list
  function renderPlayers() {
    const p1 = $('player1Select');
    const p2 = $('player2Select');
    const practiceSelect = $('practicePlayerSelect');
    const list = $('playerList');
    
    p1.innerHTML = '';
    p2.innerHTML = '';
    practiceSelect.innerHTML = '';
    list.innerHTML = '';
    
    if (players.length === 0) {
      list.innerHTML = '<div style="padding: 1rem; text-align: center; color: #888;">No players yet. Create one above.</div>';
    }
    
    players.forEach((player, index) => {
      const o1 = document.createElement('option');
      o1.value = player.name;
      o1.textContent = player.name;
      p1.appendChild(o1);
      
      const o2 = document.createElement('option');
      o2.value = player.name;
      o2.textContent = player.name;
      p2.appendChild(o2);
      
      const oPractice = document.createElement('option');
      oPractice.value = player.name;
      oPractice.textContent = player.name;
      practiceSelect.appendChild(oPractice);
      
      const item = document.createElement('div');
      item.className = 'player-item';
      item.setAttribute('role', 'listitem');
      item.innerHTML = `
        <span>${player.name}</span>
        <div>
          <button class="btn-secondary view-stats-btn" data-player="${player.name}" aria-label="View stats for ${player.name}">Stats</button>
          <button class="btn-danger delete-player-btn" data-index="${index}" aria-label="Delete ${player.name}">Delete</button>
        </div>
      `;
      list.appendChild(item);
    });
    
    if (players.length > 1) {
      p2.selectedIndex = 1;
    }
  }
  
  // Add new player
  function addPlayer() {
    const input = $('newPlayerInput');
    const name = input.value.trim();
    
    if (!name) {
      alert('Please enter a player name');
      return;
    }
    
    if (players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
      alert('Player already exists');
      return;
    }
    
    players.push({ name, createdAt: Date.now() });
    savePlayers();
    renderPlayers();
    input.value = '';
  }
  
  // Delete player
  function deletePlayer(index) {
    const player = players[index];
    if (confirm(`Delete player "${player.name}"? This will also delete their stats.`)) {
      delete stats[player.name];
      players.splice(index, 1);
      savePlayers();
      saveStats();
      renderPlayers();
    }
  }
  
  // Start match
  function startMatch() {
    const p1 = $('player1Select').value;
    const p2 = $('player2Select').value;
    const gameType = parseInt($('gameTypeSelect').value, 10);
    const matchFormat = $('matchFormatSelect').value;
    const bestOf = parseInt($('matchLengthSelect').value, 10);
    
    if (!p1 || !p2) {
      alert('Please select both players');
      return;
    }
    
    if (p1 === p2) {
      alert('Please select two different players');
      return;
    }
    
    const year = new Date().getFullYear();
    initPlayerStats(p1, year);
    initPlayerStats(p2, year);
    
    match = {
      players: [p1, p2],
      gameType: gameType,
      startScore: gameType,
      matchFormat: matchFormat,
      bestOf: bestOf,
      legsToWin: matchFormat === 'legs' ? Math.ceil(bestOf / 2) : 3,
      setsToWin: matchFormat === 'sets' ? Math.ceil(bestOf / 2) : null,
      scores: [gameType, gameType],
      legScores: [0, 0],
      setScores: [0, 0],
      turn: 0,
      dartCount: 0,
      history: [],
      legHistory: [],
      first9Scores: [[], []],
      year: year
    };
    
    $('p1NameDisplay').textContent = p1;
    $('p2NameDisplay').textContent = p2;
    $('webcam1Label').textContent = p1;
    $('webcam2Label').textContent = p2;
    
    updateMatchDisplay();
    showPage('matchPage');
  }
  
  // Update match display
  function updateMatchDisplay() {
    if (!match) return;
    
    let scoreText;
    if (match.matchFormat === 'sets') {
      scoreText = `${match.setScores[0]} - ${match.setScores[1]}`;
      if (match.legScores[0] > 0 || match.legScores[1] > 0) {
        scoreText += ` (${match.legScores[0]}-${match.legScores[1]})`;
      }
    } else {
      scoreText = `${match.legScores[0]} - ${match.legScores[1]}`;
    }
    $('matchScoreDisplay').textContent = scoreText;
    
    renderScoreTable();
  }
  
  // Render score table - both players on same row per round
  function renderScoreTable() {
    const tbody = $('scoreTableBody');
    tbody.innerHTML = '';
    
    // Group history into rounds (each round = both players have thrown)
    const rounds = [];
    let currentRound = { p1: null, p2: null, dartCount: 0 };
    
    match.history.forEach((turn, idx) => {
      if (turn.player === 0) {
        if (currentRound.p1 !== null) {
          rounds.push(currentRound);
          currentRound = { p1: null, p2: null, dartCount: 0 };
        }
        currentRound.p1 = { ...turn, historyIdx: idx };
        currentRound.dartCount = turn.dartCount;
      } else {
        currentRound.p2 = { ...turn, historyIdx: idx };
        currentRound.dartCount = turn.dartCount;
      }
    });
    if (currentRound.p1 !== null || currentRound.p2 !== null) {
      rounds.push(currentRound);
    }
    
    // Current scores row (shows current "To Go" for both players)
    const currentRow = document.createElement('tr');
    currentRow.className = 'current-turn';
    currentRow.innerHTML = `
      <td class="scored" style="background: ${match.turn === 0 ? 'rgba(46, 204, 113, 0.3)' : 'transparent'}">
        ${match.turn === 0 ? '>' : ''}
      </td>
      <td class="to-go" style="background: ${match.turn === 0 ? 'rgba(46, 204, 113, 0.3)' : 'transparent'}">
        ${match.scores[0]}
      </td>
      <td class="dart-count">${match.dartCount}</td>
      <td class="to-go" style="background: ${match.turn === 1 ? 'rgba(46, 204, 113, 0.3)' : 'transparent'}">
        ${match.scores[1]}
      </td>
      <td class="scored" style="background: ${match.turn === 1 ? 'rgba(46, 204, 113, 0.3)' : 'transparent'}">
        ${match.turn === 1 ? '<' : ''}
      </td>
    `;
    tbody.appendChild(currentRow);
    
    // History rows - show rounds in reverse order (most recent first)
    rounds.slice().reverse().forEach((round) => {
      const row = document.createElement('tr');
      row.className = 'editable';
      
      const p1Scored = round.p1 ? round.p1.scored : '';
      const p1ToGo = round.p1 ? round.p1.toGo : '';
      const p2Scored = round.p2 ? round.p2.scored : '';
      const p2ToGo = round.p2 ? round.p2.toGo : '';
      
      row.innerHTML = `
        <td class="p1-cell" data-idx="${round.p1 ? round.p1.historyIdx : ''}">${p1Scored}</td>
        <td class="p1-cell" data-idx="${round.p1 ? round.p1.historyIdx : ''}">${p1ToGo}</td>
        <td class="dart-count">${round.dartCount}</td>
        <td class="p2-cell" data-idx="${round.p2 ? round.p2.historyIdx : ''}">${p2ToGo}</td>
        <td class="p2-cell" data-idx="${round.p2 ? round.p2.historyIdx : ''}">${p2Scored}</td>
      `;
      
      // Add click handlers for editing
      row.querySelectorAll('.p1-cell').forEach(cell => {
        if (cell.dataset.idx !== '') {
          cell.style.cursor = 'pointer';
          cell.addEventListener('click', () => openEditModal(parseInt(cell.dataset.idx, 10)));
        }
      });
      row.querySelectorAll('.p2-cell').forEach(cell => {
        if (cell.dataset.idx !== '') {
          cell.style.cursor = 'pointer';
          cell.addEventListener('click', () => openEditModal(parseInt(cell.dataset.idx, 10)));
        }
      });
      
      tbody.appendChild(row);
    });
  }
  
  // Keypad input
  function pressNum(n) {
    if (inputValue.length < 3) {
      inputValue += n;
      $('scoreDisplay').textContent = inputValue;
    }
  }
  
  function backspace() {
    inputValue = inputValue.slice(0, -1);
    $('scoreDisplay').textContent = inputValue;
  }
  
  function clearInput() {
    inputValue = '';
    $('scoreDisplay').textContent = '';
  }
  
  // Submit score
  function submitScore() {
    if (!inputValue || !match) return;
    
    const value = parseInt(inputValue, 10);
    
    if (value > MAX_SCORE) {
      alert(`Maximum score per turn is ${MAX_SCORE}`);
      clearInput();
      return;
    }
    
    const idx = match.turn;
    const before = match.scores[idx];
    const after = before - value;
    
    // Track first 9 darts
    if (match.first9Scores[idx].length < 3) {
      match.first9Scores[idx].push(value);
    }
    
    // Track high scores for stats
    const year = match.year;
    const playerStats = stats[match.players[idx]][year];
    
    if (value >= 180) playerStats.scores180++;
    else if (value >= 140) playerStats.scores140++;
    else if (value >= 100) playerStats.scores100++;
    
    playerStats.totalScore += value;
    playerStats.totalThrows++;
    
    if (after < 0 || after === 1) {
      // Bust
      match.history.push({
        player: idx,
        scored: value + ' (BUST)',
        toGo: before,
        dartCount: match.dartCount + 3,
        actualScore: 0
      });
      match.dartCount += 3;
      match.turn = match.turn === 0 ? 1 : 0;
      clearInput();
      updateMatchDisplay();
      return;
    }
    
    if (after === 0) {
      // Checkout - ask which dart
      pendingCheckout = { value, idx, before };
      showModal('checkoutModal');
      return;
    }
    
    // Normal score
    match.scores[idx] = after;
    match.history.push({
      player: idx,
      scored: value,
      toGo: after,
      dartCount: match.dartCount + 3,
      actualScore: value
    });
    match.dartCount += 3;
    match.turn = match.turn === 0 ? 1 : 0;
    
    clearInput();
    updateMatchDisplay();
    saveStats();
  }
  
  // Complete checkout
  function completeCheckout(dartNumber) {
    if (!pendingCheckout || !match) return;
    
    const { value, idx, before } = pendingCheckout;
    const dartsUsed = dartNumber;
    const totalDarts = match.dartCount + dartsUsed;
    
    // Update stats
    const year = match.year;
    const playerStats = stats[match.players[idx]][year];
    
    // High out
    if (value > playerStats.highOut) {
      playerStats.highOut = value;
    }
    
    // Best/worst leg (darts to finish)
    if (playerStats.bestLeg === null || totalDarts < playerStats.bestLeg) {
      playerStats.bestLeg = totalDarts;
    }
    if (playerStats.worstLeg === null || totalDarts > playerStats.worstLeg) {
      playerStats.worstLeg = totalDarts;
    }
    
    // First 9 average
    const first9 = match.first9Scores[idx];
    if (first9.length > 0) {
      const first9Avg = first9.reduce((a, b) => a + b, 0) / first9.length * 3;
      playerStats.first9Total += first9Avg;
      playerStats.first9Count++;
    }
    
    playerStats.totalDarts += totalDarts;
    playerStats.totalLegsForAvg++;
    playerStats.legsWon++;
    playerStats.legsPlayed++;
    
    // Update opponent's legs played
    const opponentIdx = idx === 0 ? 1 : 0;
    stats[match.players[opponentIdx]][year].legsPlayed++;
    
    match.scores[idx] = 0;
    match.history.push({
      player: idx,
      scored: value + ' (OUT)',
      toGo: 0,
      dartCount: totalDarts,
      actualScore: value,
      checkout: true,
      checkoutDart: dartNumber
    });
    
    match.legScores[idx]++;
    
    hideModal('checkoutModal');
    pendingCheckout = null;
    clearInput();
    
    // Check for set/match win
    checkWinCondition(idx);
    
    saveStats();
  }
  
  // Check win condition
  function checkWinCondition(winnerIdx) {
    const winner = match.players[winnerIdx];
    const year = match.year;
    
    if (match.matchFormat === 'sets') {
      // Check if set is won
      if (match.legScores[winnerIdx] >= 3) {
        match.setScores[winnerIdx]++;
        stats[winner][year].setsWon++;
        stats[winner][year].setsPlayed++;
        stats[match.players[winnerIdx === 0 ? 1 : 0]][year].setsPlayed++;
        
        // Check if match is won
        if (match.setScores[winnerIdx] >= match.setsToWin) {
          $('matchWonMessage').textContent = `${winner} wins the match ${match.setScores[0]} - ${match.setScores[1]} sets!`;
          showModal('matchWonModal');
          updateMatchDisplay();
          return;
        }
        
        // Reset legs for new set
        match.legScores = [0, 0];
        $('legWonMessage').textContent = `${winner} wins the set! Score: ${match.setScores[0]} - ${match.setScores[1]}`;
        showModal('legWonModal');
        resetLeg();
        return;
      }
    } else {
      // Best of legs
      if (match.legScores[winnerIdx] >= match.legsToWin) {
        $('matchWonMessage').textContent = `${winner} wins the match ${match.legScores[0]} - ${match.legScores[1]} legs!`;
        showModal('matchWonModal');
        updateMatchDisplay();
        return;
      }
    }
    
    // Leg won but match continues
    $('legWonMessage').textContent = `${winner} wins the leg! Score: ${match.legScores[0]} - ${match.legScores[1]}`;
    showModal('legWonModal');
    resetLeg();
  }
  
  // Reset leg
  function resetLeg() {
    match.scores = [match.startScore, match.startScore];
    match.dartCount = 0;
    match.history = [];
    match.first9Scores = [[], []];
    // Alternate who starts
    match.turn = (match.legScores[0] + match.legScores[1] + match.setScores[0] + match.setScores[1]) % 2;
    updateMatchDisplay();
  }
  
  // Edit score modal
  function openEditModal(turnIndex) {
    const turn = match.history[turnIndex];
    if (!turn || turn.checkout) return; // Can't edit checkouts
    
    editingTurn = turnIndex;
    $('editScoreInput').value = turn.actualScore || 0;
    showModal('editModal');
  }
  
  function saveEdit() {
    if (editingTurn === null) return;
    
    const newScore = parseInt($('editScoreInput').value, 10);
    if (isNaN(newScore) || newScore < 0 || newScore > MAX_SCORE) {
      alert('Invalid score');
      return;
    }
    
    // Recalculate from edit point
    const turn = match.history[editingTurn];
    const oldScore = turn.actualScore || 0;
    const diff = newScore - oldScore;
    
    turn.actualScore = newScore;
    turn.scored = newScore;
    
    // Recalculate all subsequent scores
    let runningScores = [match.startScore, match.startScore];
    
    for (let i = 0; i < match.history.length; i++) {
      const t = match.history[i];
      if (t.actualScore !== undefined) {
        runningScores[t.player] -= t.actualScore;
        t.toGo = runningScores[t.player];
      }
    }
    
    match.scores = runningScores;
    
    hideModal('editModal');
    editingTurn = null;
    updateMatchDisplay();
  }
  
  // View stats
  function viewStats(playerName) {
    statsViewPlayer = playerName;
    statsViewYear = new Date().getFullYear();
    $('statsPlayerName').textContent = `${playerName} - Stats`;
    renderStats();
    showPage('statsPage');
  }
  
  function renderStats() {
    $('statsYear').textContent = statsViewYear;
    
    const playerStats = stats[statsViewPlayer] && stats[statsViewPlayer][statsViewYear];
    
    if (!playerStats) {
      $('statSets').textContent = '0 / 0 (0%)';
      $('statLegs').textContent = '0 / 0 (0%)';
      $('stat100').textContent = '0';
      $('stat140').textContent = '0';
      $('stat180').textContent = '0';
      $('statHighOut').textContent = '0';
      $('statBestLeg').textContent = '-';
      $('statWorstLeg').textContent = '-';
      $('statAvgDarts').textContent = '0';
      $('statAvgScore').textContent = '0';
      $('statFirst9').textContent = '0';
      return;
    }
    
    const setsPercent = playerStats.setsPlayed > 0 ? ((playerStats.setsWon / playerStats.setsPlayed) * 100).toFixed(1) : 0;
    const legsPercent = playerStats.legsPlayed > 0 ? ((playerStats.legsWon / playerStats.legsPlayed) * 100).toFixed(1) : 0;
    const avgDarts = playerStats.totalLegsForAvg > 0 ? (playerStats.totalDarts / playerStats.totalLegsForAvg).toFixed(2) : 0;
    const avgScore = playerStats.totalThrows > 0 ? ((playerStats.totalScore / playerStats.totalThrows) * 3).toFixed(2) : 0;
    const first9Avg = playerStats.first9Count > 0 ? (playerStats.first9Total / playerStats.first9Count).toFixed(2) : 0;
    
    $('statSets').textContent = `${playerStats.setsWon} / ${playerStats.setsPlayed} (${setsPercent}%)`;
    $('statLegs').textContent = `${playerStats.legsWon} / ${playerStats.legsPlayed} (${legsPercent}%)`;
    $('stat100').textContent = playerStats.scores100;
    $('stat140').textContent = playerStats.scores140;
    $('stat180').textContent = playerStats.scores180;
    $('statHighOut').textContent = playerStats.highOut;
    $('statBestLeg').textContent = playerStats.bestLeg || '-';
    $('statWorstLeg').textContent = playerStats.worstLeg || '-';
    $('statAvgDarts').textContent = avgDarts;
    $('statAvgScore').textContent = avgScore;
    $('statFirst9').textContent = first9Avg;
  }
  
  // Webcam functions - individual toggles per player
  let webcam1Stream = null;
  let webcam2Stream = null;
  
  async function toggleWebcam(playerNum) {
    const btn = $(`toggleWebcam${playerNum}Btn`);
    const video = $(`webcam${playerNum}`);
    const placeholder = $(`webcam${playerNum}Placeholder`);
    const streamVar = playerNum === 1 ? 'webcam1Stream' : 'webcam2Stream';
    
    // Check if this webcam is currently enabled
    const currentStream = playerNum === 1 ? webcam1Stream : webcam2Stream;
    
    if (currentStream) {
      // Disable this webcam
      currentStream.getTracks().forEach(track => track.stop());
      if (playerNum === 1) {
        webcam1Stream = null;
      } else {
        webcam2Stream = null;
      }
      video.srcObject = null;
      video.style.display = 'none';
      placeholder.innerHTML = '<span>Webcam Off</span><small>Click "Enable" above</small>';
      placeholder.style.display = 'flex';
      btn.textContent = 'Enable';
      btn.classList.remove('active');
    } else {
      // Enable this webcam
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === 'videoinput');
        
        if (videoDevices.length === 0) {
          alert('No webcams found. Connect a webcam and try again.');
          return;
        }
        
        // Determine which device to use
        // Player 1 gets first available, Player 2 gets second if available, else first
        let deviceIndex = 0;
        if (playerNum === 2 && videoDevices.length > 1) {
          // Check if Player 1 is using the first device
          if (webcam1Stream) {
            deviceIndex = 1;
          }
        } else if (playerNum === 2 && webcam1Stream) {
          // Only one webcam and Player 1 is using it
          placeholder.innerHTML = '<span>No available webcam</span><small>Player 1 is using the only webcam</small>';
          return;
        }
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: { deviceId: videoDevices[deviceIndex].deviceId } 
        });
        
        if (playerNum === 1) {
          webcam1Stream = stream;
        } else {
          webcam2Stream = stream;
        }
        
        video.srcObject = stream;
        video.style.display = 'block';
        placeholder.style.display = 'none';
        btn.textContent = 'Disable';
        btn.classList.add('active');
      } catch (err) {
        alert('Could not access webcam: ' + err.message);
      }
    }
  }
  
  function stopAllWebcams() {
    if (webcam1Stream) {
      webcam1Stream.getTracks().forEach(track => track.stop());
      webcam1Stream = null;
    }
    if (webcam2Stream) {
      webcam2Stream.getTracks().forEach(track => track.stop());
      webcam2Stream = null;
    }
  }
  
  // End match
  function endMatch() {
    stopAllWebcams();
    match = null;
    clearInput();
    showPage('homePage');
  }
  
  // ==================== PRACTICE MODE ====================
  
  function startPractice() {
    const playerName = $('practicePlayerSelect').value;
    const gameType = parseInt($('practiceGameTypeSelect').value, 10);
    
    if (!playerName) {
      alert('Please select a player');
      return;
    }
    
    const year = new Date().getFullYear();
    initPlayerStats(playerName, year);
    
    practice = {
      player: playerName,
      gameType: gameType,
      score: gameType,
      dartCount: 0,
      history: [],
      legsWon: 0,
      totalScore: 0,
      totalThrows: 0,
      first9Scores: [],
      year: year
    };
    
    $('practicePlayerName').textContent = playerName;
    updatePracticeDisplay();
    showPage('practicePage');
  }
  
  function updatePracticeDisplay() {
    if (!practice) return;
    
    $('practiceToGo').textContent = practice.score;
    $('practiceDartCount').textContent = practice.dartCount;
    $('practiceLegsWon').textContent = practice.legsWon;
    
    const avg = practice.totalThrows > 0 
      ? ((practice.totalScore / practice.totalThrows) * 3).toFixed(2) 
      : '0.00';
    $('practiceAvg').textContent = avg;
    
    renderPracticeScoreTable();
  }
  
  function renderPracticeScoreTable() {
    const tbody = $('practiceScoreTableBody');
    tbody.innerHTML = '';
    
    practice.history.slice().reverse().forEach((turn) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${turn.scored}</td>
        <td>${turn.toGo}</td>
        <td>${turn.dartCount}</td>
      `;
      tbody.appendChild(row);
    });
  }
  
  function practicePress(n) {
    if (practiceInputValue.length < 3) {
      practiceInputValue += n;
      $('practiceScoreDisplay').textContent = practiceInputValue;
    }
  }
  
  function practiceBackspace() {
    practiceInputValue = practiceInputValue.slice(0, -1);
    $('practiceScoreDisplay').textContent = practiceInputValue;
  }
  
  function clearPracticeInput() {
    practiceInputValue = '';
    $('practiceScoreDisplay').textContent = '';
  }
  
  function submitPracticeScore() {
    if (!practiceInputValue || !practice) return;
    
    const value = parseInt(practiceInputValue, 10);
    
    if (value > MAX_SCORE) {
      alert(`Maximum score per turn is ${MAX_SCORE}`);
      clearPracticeInput();
      return;
    }
    
    const before = practice.score;
    const after = before - value;
    
    // Track first 9 darts
    if (practice.first9Scores.length < 3) {
      practice.first9Scores.push(value);
    }
    
    // Track stats
    const year = practice.year;
    const playerStats = stats[practice.player][year];
    
    if (value >= 180) playerStats.scores180++;
    else if (value >= 140) playerStats.scores140++;
    else if (value >= 100) playerStats.scores100++;
    
    practice.totalScore += value;
    practice.totalThrows++;
    playerStats.totalScore += value;
    playerStats.totalThrows++;
    
    if (after < 0 || after === 1) {
      // Bust
      practice.history.push({
        scored: value + ' (BUST)',
        toGo: before,
        dartCount: practice.dartCount + 3
      });
      practice.dartCount += 3;
      clearPracticeInput();
      updatePracticeDisplay();
      saveStats();
      return;
    }
    
    if (after === 0) {
      // Checkout - ask which dart
      practicePendingCheckout = { value, before };
      showModal('practiceCheckoutModal');
      return;
    }
    
    // Normal score
    practice.score = after;
    practice.history.push({
      scored: value,
      toGo: after,
      dartCount: practice.dartCount + 3
    });
    practice.dartCount += 3;
    
    clearPracticeInput();
    updatePracticeDisplay();
    saveStats();
  }
  
  function completePracticeCheckout(dartNumber) {
    hideModal('practiceCheckoutModal');
    
    if (!practicePendingCheckout || !practice) return;
    
    const { value, before } = practicePendingCheckout;
    const dartsUsed = practice.dartCount + dartNumber;
    
    // Update stats
    const year = practice.year;
    const playerStats = stats[practice.player][year];
    
    playerStats.legsWon++;
    playerStats.legsPlayed++;
    playerStats.totalDarts += dartsUsed;
    playerStats.totalLegsForAvg++;
    
    if (value > playerStats.highOut) {
      playerStats.highOut = value;
    }
    
    if (!playerStats.bestLeg || dartsUsed < playerStats.bestLeg) {
      playerStats.bestLeg = dartsUsed;
    }
    if (!playerStats.worstLeg || dartsUsed > playerStats.worstLeg) {
      playerStats.worstLeg = dartsUsed;
    }
    
    // First 9 average
    if (practice.first9Scores.length > 0) {
      const first9Sum = practice.first9Scores.reduce((a, b) => a + b, 0);
      playerStats.first9Total += first9Sum;
      playerStats.first9Count++;
    }
    
    practice.history.push({
      scored: value + ' (OUT)',
      toGo: 0,
      dartCount: dartsUsed
    });
    
    practice.legsWon++;
    
    // Show leg complete modal
    $('practiceLegWonMessage').textContent = `Leg completed in ${dartsUsed} darts!`;
    showModal('practiceLegWonModal');
    
    practicePendingCheckout = null;
    clearPracticeInput();
    saveStats();
  }
  
  function resetPracticeLeg() {
    if (!practice) return;
    
    practice.score = practice.gameType;
    practice.dartCount = 0;
    practice.history = [];
    practice.first9Scores = [];
    
    clearPracticeInput();
    updatePracticeDisplay();
  }
  
  function endPractice() {
    practice = null;
    clearPracticeInput();
    showPage('homePage');
  }
  
  // Event listeners
  document.addEventListener('DOMContentLoaded', function() {
    loadData();
    renderPlayers();
    
    // Home page
    $('addPlayerBtn').addEventListener('click', addPlayer);
    $('newPlayerInput').addEventListener('keypress', e => { if (e.key === 'Enter') addPlayer(); });
    $('startMatchBtn').addEventListener('click', startMatch);
    $('startPracticeBtn').addEventListener('click', startPractice);
    
    // Player list delegation
    $('playerList').addEventListener('click', function(e) {
      if (e.target.classList.contains('delete-player-btn')) {
        deletePlayer(parseInt(e.target.dataset.index, 10));
      } else if (e.target.classList.contains('view-stats-btn')) {
        viewStats(e.target.dataset.player);
      }
    });
    
    // Match page
    document.querySelectorAll('[data-num]').forEach(btn => {
      btn.addEventListener('click', () => pressNum(btn.dataset.num));
    });
    $('backspaceBtn').addEventListener('click', backspace);
    $('enterBtn').addEventListener('click', submitScore);
    
    $('newLegBtn').addEventListener('click', () => {
      if (match && confirm('Start a new leg? Current progress will be lost.')) {
        resetLeg();
      }
    });
    
    $('finishBtn').addEventListener('click', () => {
      if (match && match.scores[match.turn] <= 170) {
        alert('Enter your checkout score using the keypad');
      }
    });
    
    $('statsBtn').addEventListener('click', () => {
      if (match) viewStats(match.players[match.turn]);
    });
    
    $('menuBtn').addEventListener('click', () => showModal('menuModal'));
    $('closeMenuBtn').addEventListener('click', () => hideModal('menuModal'));
    $('homeBtn').addEventListener('click', () => {
      hideModal('menuModal');
      if (confirm('Return to home? Match progress will be lost.')) {
        endMatch();
      }
    });
    $('cancelMatchBtn').addEventListener('click', () => {
      hideModal('menuModal');
      if (confirm('Cancel match? All progress will be lost.')) {
        endMatch();
      }
    });
    
    $('toggleWebcam1Btn').addEventListener('click', () => toggleWebcam(1));
    $('toggleWebcam2Btn').addEventListener('click', () => toggleWebcam(2));
    
    // Checkout modal
    $('dart1Btn').addEventListener('click', () => completeCheckout(1));
    $('dart2Btn').addEventListener('click', () => completeCheckout(2));
    $('dart3Btn').addEventListener('click', () => completeCheckout(3));
    
    // Edit modal
    $('saveEditBtn').addEventListener('click', saveEdit);
    $('cancelEditBtn').addEventListener('click', () => {
      hideModal('editModal');
      editingTurn = null;
    });
    
    // Leg won modal
    $('continueLegBtn').addEventListener('click', () => {
      hideModal('legWonModal');
      updateMatchDisplay();
    });
    
    // Match won modal
    $('newMatchBtn').addEventListener('click', () => {
      hideModal('matchWonModal');
      endMatch();
    });
    
    // Stats page
    $('backFromStatsBtn').addEventListener('click', () => {
      if (match) {
        showPage('matchPage');
      } else if (practice) {
        showPage('practicePage');
      } else {
        showPage('homePage');
      }
    });
    
    $('prevYearBtn').addEventListener('click', () => {
      statsViewYear--;
      renderStats();
    });
    
    $('nextYearBtn').addEventListener('click', () => {
      statsViewYear++;
      renderStats();
    });
    
    // Practice page
    document.querySelectorAll('.practice-num').forEach(btn => {
      btn.addEventListener('click', () => practicePress(btn.dataset.num));
    });
    $('practiceBackspaceBtn').addEventListener('click', practiceBackspace);
    $('practiceEnterBtn').addEventListener('click', submitPracticeScore);
    
    $('practiceNewLegBtn').addEventListener('click', () => {
      if (practice && confirm('Start a new leg? Current progress will be lost.')) {
        resetPracticeLeg();
      }
    });
    
    $('practiceFinishBtn').addEventListener('click', () => {
      if (practice && practice.score <= 170) {
        alert('Enter your checkout score using the keypad');
      }
    });
    
    $('practiceStatsBtn').addEventListener('click', () => {
      if (practice) viewStats(practice.player);
    });
    
    $('practiceMenuBtn').addEventListener('click', () => showModal('practiceMenuModal'));
    $('closePracticeMenuBtn').addEventListener('click', () => hideModal('practiceMenuModal'));
    $('practiceHomeBtn').addEventListener('click', () => {
      hideModal('practiceMenuModal');
      if (confirm('Return to home? Practice progress will be lost.')) {
        endPractice();
      }
    });
    $('practiceEndBtn').addEventListener('click', () => {
      hideModal('practiceMenuModal');
      if (confirm('End practice session?')) {
        endPractice();
      }
    });
    
    // Practice checkout modal
    $('practiceDart1Btn').addEventListener('click', () => completePracticeCheckout(1));
    $('practiceDart2Btn').addEventListener('click', () => completePracticeCheckout(2));
    $('practiceDart3Btn').addEventListener('click', () => completePracticeCheckout(3));
    
    // Practice leg won modal
    $('practiceNextLegBtn').addEventListener('click', () => {
      hideModal('practiceLegWonModal');
      resetPracticeLeg();
      updatePracticeDisplay();
    });
    $('practiceEndSessionBtn').addEventListener('click', () => {
      hideModal('practiceLegWonModal');
      endPractice();
    });
    
    // Keyboard support
    document.addEventListener('keydown', function(e) {
      if (document.querySelector('.modal.active')) return;
      if (document.activeElement.tagName === 'INPUT') return;
      
      if ($('matchPage').classList.contains('active')) {
        if (e.key >= '0' && e.key <= '9') {
          pressNum(e.key);
        } else if (e.key === 'Backspace') {
          backspace();
        } else if (e.key === 'Enter') {
          submitScore();
        }
      } else if ($('practicePage').classList.contains('active')) {
        if (e.key >= '0' && e.key <= '9') {
          practicePress(e.key);
        } else if (e.key === 'Backspace') {
          practiceBackspace();
        } else if (e.key === 'Enter') {
          submitPracticeScore();
        }
      }
    });
  });
})();
</script>

</body>
</html>
